# 高性能内存池模拟 ( 基于 tcmalloc )

## :open_book:项目简介

本项目是一个**高性能并发内存池**模拟实现，参考自 Google 开源项目**tcmalloc (Thread-Caching Malloc)**的核心思想。目的是通过简化和学习tcmalloc的架构，掌握高效内存管理、多线程内存分配优化等技术。

项目特点：

- 参考tcmalloc内核，设计了**ThreadCache**、**CentralCache**、**PageCache**三层缓存机制。
- 重点解决多线程下的内存分配性能问题和内存碎片问题。
- 使用了 **池化技术**，提前申请大块内存进行管理，提升分配和释放效率。
- 支持定长对象池、页分配器、自定义对齐与分桶策略。

## :open_book:项目结构

#### :file_folder:三层缓存结构

- **`ThreadCache`**：线程私有的小对象缓存，无需加锁，快速分配和回收内存。
- **`CentralCache`**：中心缓存，多个线程共享，负责按需批量供给`ThreadCache`，采用桶锁减少竞争。
- **`PageCache`**：以页为单位的大内存块管理器，处理大块内存分配与回收，支持页合并以缓解内存碎片。

#### :file_folder:辅助结构

- **自由链表**：管理小块对象的链表结构。
- **对象池**：用于小对象频繁申请与释放的场景。
- **高效内存映射表**：用于对象到Span的快速映射。

## :open_book:技术细节

- **多线程并发**：使用线程层存储（TLS）和层级缓存提升并发性能。

- **高效哈希映射**：内存块大小映射到合适的桶，减少内部碎片。

- **页分配优化**：内存申请不足时，从系统批量申请页，按需拆分。

- **内存碎片处理**：

  - 外部碎片：通过页合并机制缓解。
  - 内部碎片：合理对齐小对象，控制在10%左右。

- **性能对比**：通过基准测试，与系统malloc/free相比，在多线程环境下显著提升分配性能。

  |                   测试内容                    | 测试1  | 测试2  | 测试3  |
  | :-------------------------------------------: | :----: | :----: | :----: |
  |    4线程并发，每轮 concurrent alloc 1000次    | 84 ms  | 76 ms  | 78 ms  |
  |   4线程并发，每轮 concurrent dealloc 1000次   | 21 ms  | 20 ms  | 23 ms  |
  | 4线程并发 concurrent alloc和dealloc 共80000次 | 105 ms | 96 ms  | 101 ms |
  |         4线程并发，每轮malloc 1000次          | 257 ms | 174 ms | 188 ms |
  |          4线程并发，每轮free 1000次           | 163 ms | 106 ms | 126 ms |
  |       4线程并发 malloc和free 共80000次        | 420 ms | 280 ms | 314 ms |

## :open_book:编译与运行

### 环境要求

- C++11 及以上标准
- 支持多线程
- 支持标准库 STL

### 示例运行

程序将进行多线程环境下的分配与释放性能对比测试：

- `BenchmarkConcurrentMalloc`：使用本项目的内存池分配器
- `BenchmarkMalloc`：使用系统默认 malloc/free

结果将显示分配与释放耗时对比。

## :open_book:项目来源与参考

本项目为学习研究用途，参考了以下内容：

- [tcmalloc 官方仓库](https://gitee.com/mirrors/tcmalloc)
- [高并发内存池学习项目](https://gitee.com/HGtz2222/bitproject/tree/master)
- 各类 malloc、内存池实现原理文章

## :open_book:注意事项

- 本项目仅为学习与实践高性能内存管理技术，不可直接用于生产环境。
- 部分接口和特性根据学习需求进行了简化与调整。